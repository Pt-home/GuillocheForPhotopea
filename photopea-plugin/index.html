<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Guilloché for Photopea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: #e6f0ff; background:#0b0e12; }
    .wrap { display: grid; gap: 12px; padding: 16px; text-align:center}
    h1 { margin: 0; font-size: 20px; letter-spacing: .3px; }
    .fp { margin-top: -16px; font-size: 14px; letter-spacing: .3px; }
    p  { margin: 0; color: #b7c7e0; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border:1px solid #2a3250; border-radius:8px; background:#121826;
      color:#e6f0ff; cursor:pointer; user-select:none; text-decoration:none;
    }
    .btn:hover { background:#161e30; }
    .note { font-size: 12px; color:#93a4c0; }
    .ok    { color:#7fffb9; }
    .warn  { color:#ffcf7f; }
    .err   { color:#ff8c8c; }
    .row { display:flex; gap:10px; align-items:center; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Guilloché</h1>
    <p class="fp">for Photopea</p>
    <p><img src="rose.png" width="160">
    <p>Generate "guilloches" lines externally, <br>then import the result here <br> as a new document.</p>

    <button id="btn-open" class="btn" type="button">Open generator</button>

    <div id="status" class="note"></div>
    <div id="debug" class="note hidden"></div>
  </div>

  <script>
    // --- Config ---
    const GEN_URL_BASE = "https://pt-home.github.io/GuillocheForPhotopea/";
    const GEN_ORIGIN   = "https://pt-home.github.io";
    const ALLOWED_PP   = new Set(["https://www.photopea.com", "https://www.vectorpea.com"]);

    // --- UI refs ---
    const $status = document.getElementById('status');
    const $debug  = document.getElementById('debug');
    const $open   = document.getElementById('btn-open');

    function setStatus(html, cls) {
      $status.className = "note " + (cls || "");
      $status.innerHTML = html;
    }
    function esc(s){ return String(s).replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m])); }
    function sanitizeForScript(str){
      return String(str).replace(/\\/g, "\\\\").replace(/"/g, '\\"');
    }

    // --- Detect parent (Photopea/Vectorpea) origin safely ---
    function detectParentOrigin() {
      // Prefer ancestorOrigins
      const ao = location.ancestorOrigins && location.ancestorOrigins[0];
      if (ao && ALLOWED_PP.has(ao)) return ao;

      // Fallback to document.referrer
      try {
        const u = new URL(document.referrer);
        const o = `${u.protocol}//${u.host}`;
        if (ALLOWED_PP.has(o)) return o;
      } catch (_) {}

      return null;
    }

    const PARENT_ORIGIN = detectParentOrigin();
    if (!PARENT_ORIGIN) {
      setStatus("This plugin must be opened inside <b>photopea.com</b> or <b>vectorpea.com</b>.", "err");
    } else {
      setStatus(`Parent detected: <b>${esc(PARENT_ORIGIN)}</b>`, "ok");
    }

    // --- Session per click (so you can open multiple generators) ---
    let lastSession = null;

    $open?.addEventListener('click', () => {
      if (!PARENT_ORIGIN) return;

      lastSession = (self.crypto?.randomUUID && crypto.randomUUID()) ||
                    Math.random().toString(36).slice(2) + Date.now();

      const url = new URL(GEN_URL_BASE);
      url.searchParams.set("session", lastSession);
      url.searchParams.set("returnOrigin", location.origin);

      // IMPORTANT: do NOT use 'noopener', we need window.opener in generator
      const w = window.open(url.toString(), "_blank");
      if (!w) {
        setStatus("Popup blocked: allow popups for this site and retry.", "warn");
      } else {
        setStatus("Generator opened in a new tab. Export PNG/SVG there to send it back here.", "ok");
      }
    });

    // --- Receive results from generator and forward to Photopea/Vectorpea ---
    window.addEventListener('message', (e) => {
      if (e.origin !== GEN_ORIGIN) return;                         // only our generator
      const msg = e.data || {};
      const { type, session, url, dataURL } = msg;

      if (!session || session !== lastSession) return;             // only for the last opened generator
      if (!PARENT_ORIGIN) return;

      let script = null;
      if (type === "pp-import-url" && url) {
        script = `app.open("${sanitizeForScript(url)}");`;         // open as NEW document
      } else if (type === "pp-import-dataurl" && dataURL) {
        script = `app.open("${sanitizeForScript(dataURL)}");`;     // open as NEW document
      } else {
        return;
      }

      // Send Live Script to the detected parent origin (Photopea OR Vectorpea)
      window.parent.postMessage(script, PARENT_ORIGIN);
      setStatus("Sent to Photopea / Vectorpea. Check the editor tab.", "ok");
    });
  </script>
</body>
</html>
