<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Guilloche Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <style>
    #view { background: #0b0e12; }
    /* helper styles for Photopea actions */
    .pp-actions { margin-left: 12px; display: inline-flex; gap: 8px; flex-wrap: wrap; }
    .pp-actions button {
      padding: 6px 10px; border-radius: 8px; border: 1px solid #2a3250;
      background:#121826; color:#e6f0ff; cursor:pointer;
    }
    .pp-actions button:hover { background:#161e30; }
    .pp-status { font-size: 12px; color:#93a4c0; margin-left: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Guilloche Lab</h1>
    <div class="actions">
      <div class="method-wrap">
        <span style="margin-right:6px;">Method:</span>
        <select id="method">
          <option value="polar_harmonics">Polar Harmonics</option>
          <option value="trochoid">Trochoid / Spiro</option>
          <option value="lissajous">Lissajous</option>
          <option value="harmonograph">Harmonograph</option>
          <option value="rhodonea">Rhodonea (Rose)</option>
          <option value="superformula">Superformula</option>
          <option value="maurer_rose">Maurer Rose</option>
          <option value="superellipse">Superellipse (Lamé)</option>
          <option value="fourier">Fourier Epicycles</option>
          <option value="log_spiral">Logarithmic Spiral</option>
          <option value="cycloidal_stars">Cycloidal Stars</option>
          <option value="phyllotaxis">Phyllotaxis</option>
          <option value="rose_mix">Rose Mix</option>
          <option value="clothoid">Clothoid (Euler spiral)</option>
        </select>
      </div>
      <button id="btn-svg">Export SVG</button>
      <button id="btn-png">Export PNG</button>
      <button id="btn-save">Save JSON</button>
      <label class="file">Load JSON <input id="input-load" type="file" accept=".json" /></label>

      <!-- Photopea export buttons -->
      <div class="pp-actions">
        <button id="pp-export-png" type="button" title="Send transparent PNG to Photopea">Export PNG to Photopea</button>
        <button id="pp-export-svg" type="button" title="Send SVG to Photopea">Export SVG to Photopea</button>
        <span id="pp-status" class="pp-status"></span>
      </div>
    </div>
  </header>

  <main>
    <section class="left">
      <div id="panel"></div>
      <div class="metrics">
        <div><b>Vertices:</b> <span id="m-verts">—</span></div>
        <div><b>Length (px):</b> <span id="m-len">—</span></div>
        <div><b>Closed:</b> <span id="m-closed">—</span></div>
      </div>
    </section>
    <section class="right">
      <canvas id="view" width="900" height="900"></canvas>
    </section>
  </main>

  <footer>
    <small>Local MVP. No backend. v2.0</small>
  </footer>

  <script type="module" src="./app.js"></script>

  <!-- Bridge for Photopea / Vectorpea -->
  <script>
    (function(){
      // CONFIG
      const ALLOWED_PP = new Set(["https://www.photopea.com", "https://www.vectorpea.com"]);
      const PLUGIN_ORIGIN = (function(){
        const url = new URL(location.href);
        const ro = url.searchParams.get("returnOrigin");
        try { return ro ? new URL(ro).origin : null; } catch { return null; }
      })();
      const session = new URLSearchParams(location.search).get("session");
      const hasOpener = !!window.opener;

      const $status = document.getElementById('pp-status');
      const setStatus = (m)=>{ if($status) $status.textContent = m; };

      if (!hasOpener || !PLUGIN_ORIGIN || !session) {
        setStatus("Tip: open from the Photopea plugin to enable direct export.");
      }

      function sendToPlugin(payload){
        if (!hasOpener || !PLUGIN_ORIGIN || !session) {
          alert("Open this generator from the Photopea plugin to enable export.");
          return false;
        }
        payload.session = session;
        window.opener.postMessage(payload, PLUGIN_ORIGIN);
        return true;
      }

      // === PNG export (TRANSPARENT) ===
      document.getElementById('pp-export-png')?.addEventListener('click', () => {
        try {
          if (typeof window.getTransparentPNGDataURL !== "function") {
            alert("Transparent export is not ready. Please update app.js (adds window.getTransparentPNGDataURL).");
            return;
          }
          const dataURL = window.getTransparentPNGDataURL(); // offscreen + transparent
          if (!dataURL) { alert("PNG export failed."); return; }
          if (sendToPlugin({ type: "pp-import-dataurl", dataURL, format: "png" })) {
            setStatus("PNG sent to Photopea.");
          }
        } catch (e) {
          console.error(e);
          alert("PNG export failed.");
        }
      });

      // === SVG export ===
      document.getElementById('pp-export-svg')?.addEventListener('click', () => {
        try {
          if (typeof window.getCurrentSVGString === "function") {
            const svg = window.getCurrentSVGString();
            const dataURL = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
            if (sendToPlugin({ type: "pp-import-dataurl", dataURL, format: "svg" })) {
              setStatus("SVG sent to Photopea.");
            }
            return;
          }
          alert("Provide window.getCurrentSVGString() in app.js to export vector SVG to Photopea.");
        } catch (e) {
          console.error(e);
          alert("SVG export failed.");
        }
      });
    })();
  </script>
</body>
</html>

